# 方法模块功能实施指南

## 已完成的功能

### 1. 数据库设计 ✓
- 新增 `MethodCategory` 表（方法分类）
- 新增 `MethodModule` 表（方法模块）
- 新增 `MethodModuleFile` 表（模块文件）
- 支持10个大类（DA, DP, QS, NLP, SNA, GIS, ML, SM, DV, CI）
- 支持约120个具体模块

### 2. 后端API ✓
**用户API** (`/api/methods/*`):
- `GET /api/methods/categories` - 获取所有分类及模块（树形数据）
- `GET /api/methods/modules` - 获取所有模块列表
- `GET /api/methods/modules/:id` - 获取单个模块详情
- `GET /api/methods/modules/:id/files/:fileId` - 下载单个文件
- `GET /api/methods/modules/:id/download` - 批量下载（ZIP）

**管理员API** (`/api/admin/methods/*`):
- `GET /api/admin/methods/categories` - 获取所有分类
- `POST /api/admin/methods/categories` - 创建分类
- `POST /api/admin/methods/modules/upload` - 上传方法模块
- `PUT /api/admin/methods/modules/:id` - 更新模块
- `DELETE /api/admin/methods/modules/:id` - 删除模块
- `POST /api/admin/methods/init` - 批量初始化数据

### 3. 前端页面 ✓
**用户端**:
- `/methods` - 交互式树形/思维导图展示页面
  - 使用 react-d3-tree 可视化
  - 支持节点点击跳转详情
  - 分类卡片列表备选视图
- `/methods/[id]` - 方法模块详情页
  - 参考案例集样式
  - 支持文件下载、README显示
  - 实操链接跳转

**管理员端**:
- `/admin/methods` - 方法模块管理页面
  - 按分类展示所有模块
  - 上传新模块（支持多文件）
  - 编辑/删除/显示/隐藏操作
  - 统计卡片展示

### 4. 导航集成 ✓
- 前台导航栏增加"方法模块"入口
- 管理后台Dashboard增加"方法模块管理"卡片

### 5. 数据初始化脚本 ✓
- `apps/api-backend/scripts/init-methods.ts`
- 自动解析"方法模块汇总.md"文件
- 批量创建分类和模块

---

## 🚀 部署步骤

### 步骤1: 重新生成Prisma Client

由于之前Prisma Client生成遇到文件锁定问题，请执行以下操作：

```bash
# 停止所有开发服务器（前端和后端）
# 然后在后端目录执行：
cd apps/api-backend
npx prisma generate
```

### 步骤2: 运行数据初始化脚本

确保"方法模块汇总.md"文件在项目根目录，然后运行：

```bash
cd apps/api-backend
npx tsx scripts/init-methods.ts
```

预期输出：
```
开始初始化方法模块数据...
解析到 10 个分类
✓ 创建分类: [DA] 数据获取
  ✓ 创建模块: [DA01] 静态网页抓取
  ✓ 创建模块: [DA02] 动态网页抓取
  ...
初始化完成！
分类: 10 个已创建, 0 个已跳过
模块: 120 个已创建, 0 个已跳过
✓ 数据初始化成功
```

### 步骤3: 启动服务

```bash
# 启动后端（在 apps/api-backend 目录）
bun run dev

# 启动前端（在 apps/web-frontend 目录）
bun run dev
```

### 步骤4: 验证功能

1. **前台验证**:
   - 访问 `http://localhost:30001/methods`
   - 查看树形图是否正确显示
   - 点击模块节点查看详情页

2. **管理后台验证**:
   - 访问 `http://localhost:30001/admin/login`
   - 登录后进入Dashboard
   - 点击"方法模块管理"卡片
   - 测试上传新模块功能

---

## 📝 使用指南

### 管理员：上传方法模块

1. 登录管理后台
2. 进入"方法模块管理"
3. 点击"上传方法模块"按钮
4. 填写表单：
   - **分类**：选择所属大类（DA, DP等）
   - **模块代码**：如 DA01
   - **模块名称**：中文名称
   - **英文名称**：English Name
   - **方法描述**：详细说明（支持Markdown）
   - **简述**：可选，简短摘要
   - **实操链接**：可选，跳转到共享算力平台
   - **上传文件**：可选，支持多个文件
5. 点击"上传"

### 管理员：编辑/删除模块

- 在模块列表中点击"显示/隐藏"切换可见性
- 点击"删除"按钮删除模块（会同时删除关联文件）

### 用户：浏览方法模块

1. 访问 `/methods` 页面
2. 使用交互式树形图：
   - 🔴 红色：根节点
   - 🔵 蓝色：分类节点（10大类）
   - 🟢 绿色：模块节点（可点击）
3. 点击绿色模块节点进入详情页
4. 在详情页可以：
   - 查看方法描述
   - 下载资源文件
   - 访问实操链接

### 用户：下载资源

- **单文件下载**：在"文件列表"Tab中点击"下载"按钮
- **批量下载**：点击"下载全部文件"按钮（ZIP打包）

---

## 🗂️ 文件结构

### 后端新增文件
```
apps/api-backend/
├── prisma/
│   └── schema.prisma                    # 新增3个model
├── src/
│   └── routes/
│       ├── methods.ts                   # 用户API路由
│       └── admin-methods.ts             # 管理员API路由
└── scripts/
    └── init-methods.ts                  # 数据初始化脚本
```

### 前端新增文件
```
apps/web-frontend/
├── app/
│   ├── (main)/
│   │   └── methods/
│   │       ├── page.tsx                 # 树形展示页
│   │       └── [id]/
│   │           └── page.tsx             # 模块详情页
│   └── admin/
│       └── methods/
│           └── page.tsx                 # 管理页面
└── config/
    └── site.ts                          # 导航配置（已更新）
```

---

## 🎨 设计特点

### 树形图可视化
- 使用 `react-d3-tree` 库
- 垂直方向展开
- 节点颜色区分类型
- 支持缩放和拖拽
- 点击节点触发详情跳转

### 详情页设计
- 参考案例集样式
- Tabs分隔不同内容区域：
  - **方法描述**：详细说明
  - **文件列表**：可下载的资源文件
  - **README**：自动加载README.md
- 统计卡片：文件数、下载量、预览量、总大小

### 管理界面
- 按分类组织模块
- 折叠式Table展示
- 模态框上传表单
- 状态切换（显示/隐藏）

---

## 🔧 技术细节

### 数据库关系
```
MethodCategory (1) ----< (N) MethodModule (1) ----< (N) MethodModuleFile
```

### API权限
- 用户API：无需认证
- 管理员API：需要JWT Token（`requireAdmin`中间件）

### 文件上传
- 使用 Multer 中间件
- 存储路径：`uploads/method-modules/`
- 支持最大10GB文件
- 自动处理中文文件名

### 树形数据转换
```typescript
// 后端返回的categories数据
[
  {
    code: "DA",
    name: "数据获取",
    modules: [...]
  }
]

// 前端转换为react-d3-tree格式
{
  name: "方法模块",
  children: [
    {
      name: "[DA] 数据获取",
      children: [
        { name: "[DA01] 静态网页抓取" },
        ...
      ]
    }
  ]
}
```

---

## ⚠️ 注意事项

1. **Prisma Client生成**：
   - 如果遇到"EPERM: operation not permitted"错误
   - 停止所有开发服务器后重试

2. **数据初始化**：
   - 脚本会跳过已存在的分类和模块
   - 可以安全地多次运行
   - 确保"方法模块汇总.md"文件格式正确

3. **文件上传限制**：
   - 单个文件最大10GB
   - 建议压缩大文件
   - 支持中文文件名

4. **实操链接**：
   - 需要勾选"启用实操链接"才会显示
   - 链接指向共享算力平台

---

## 🐛 故障排查

### 问题1: 树形图不显示
- 检查浏览器控制台错误
- 确认 `/api/methods/categories` 返回数据
- 验证 react-d3-tree 依赖已安装

### 问题2: 上传失败
- 检查JWT Token是否有效
- 确认 `uploads/method-modules/` 目录权限
- 查看后端控制台错误日志

### 问题3: 详情页404
- 确认模块 `isVisible=true`
- 检查路由参数是否正确
- 验证模块ID是否存在

---

## 🎯 后续优化建议

1. **RAG集成**：将方法模块内容向量化，支持AI搜索
2. **批量操作**：管理界面支持批量显示/隐藏/删除
3. **预览功能**：PDF/代码文件在线预览
4. **版本管理**：支持方法模块更新和版本历史
5. **关联推荐**：推荐相关的数据集/案例集
6. **使用统计**：更详细的下载和预览统计

---

## 📞 技术支持

如遇问题，请检查：
1. 浏览器控制台（前端错误）
2. 后端终端日志（API错误）
3. 数据库连接状态
4. Prisma Client是否最新

**关键文件位置**:
- Schema: `apps/api-backend/prisma/schema.prisma`
- 后端路由: `apps/api-backend/src/index.ts`
- 前端配置: `apps/web-frontend/config/site.ts`
