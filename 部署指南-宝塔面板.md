# UCASS DataShare éƒ¨ç½²æŒ‡å— - å®å¡”é¢æ¿ç‰ˆ

## ğŸ“‹ ç›®å½•

- [ç³»ç»Ÿè¦æ±‚](#ç³»ç»Ÿè¦æ±‚)
- [ç¬¬ä¸€éƒ¨åˆ†ï¼šæœåŠ¡å™¨ç¯å¢ƒå‡†å¤‡](#ç¬¬ä¸€éƒ¨åˆ†æœåŠ¡å™¨ç¯å¢ƒå‡†å¤‡)
- [ç¬¬äºŒéƒ¨åˆ†ï¼šå®‰è£…è¿è¡Œæ—¶ç¯å¢ƒ](#ç¬¬äºŒéƒ¨åˆ†å®‰è£…è¿è¡Œæ—¶ç¯å¢ƒ)
- [ç¬¬ä¸‰éƒ¨åˆ†ï¼šæ•°æ®åº“é…ç½®](#ç¬¬ä¸‰éƒ¨åˆ†æ•°æ®åº“é…ç½®)
- [ç¬¬å››éƒ¨åˆ†ï¼šé¡¹ç›®éƒ¨ç½²](#ç¬¬å››éƒ¨åˆ†é¡¹ç›®éƒ¨ç½²)
- [ç¬¬äº”éƒ¨åˆ†ï¼šå®å¡”é¢æ¿é…ç½®](#ç¬¬äº”éƒ¨åˆ†å®å¡”é¢æ¿é…ç½®)
- [ç¬¬å…­éƒ¨åˆ†ï¼šåŸŸåä¸SSLé…ç½®](#ç¬¬å…­éƒ¨åˆ†åŸŸåä¸sslé…ç½®)
- [ç¬¬ä¸ƒéƒ¨åˆ†ï¼šè¿›ç¨‹å®ˆæŠ¤ä¸è‡ªåŠ¨é‡å¯](#ç¬¬ä¸ƒéƒ¨åˆ†è¿›ç¨‹å®ˆæŠ¤ä¸è‡ªåŠ¨é‡å¯)
- [ç¬¬å…«éƒ¨åˆ†ï¼šæ—¥å¿—ä¸ç›‘æ§](#ç¬¬å…«éƒ¨åˆ†æ—¥å¿—ä¸ç›‘æ§)
- [å¸¸è§é—®é¢˜æ’æŸ¥](#å¸¸è§é—®é¢˜æ’æŸ¥)

---

## ç³»ç»Ÿè¦æ±‚

### ç¡¬ä»¶è¦æ±‚
- **CPU**: 2æ ¸åŠä»¥ä¸Š
- **å†…å­˜**: 4GB åŠä»¥ä¸Šï¼ˆæ¨è 8GBï¼‰
- **ç¡¬ç›˜**: 50GB åŠä»¥ä¸Šï¼ˆæ ¹æ®æ•°æ®é‡è°ƒæ•´ï¼‰
- **ç½‘ç»œ**: ç¨³å®šçš„ç½‘ç»œè¿æ¥

### è½¯ä»¶è¦æ±‚
- **æ“ä½œç³»ç»Ÿ**: Ubuntu 20.04 LTS æˆ–æ›´é«˜ç‰ˆæœ¬
- **å®å¡”é¢æ¿**: 7.x æˆ– 8.x ç‰ˆæœ¬
- **PostgreSQL**: 14.x æˆ–æ›´é«˜ç‰ˆæœ¬
- **Node.js**: 18.x æˆ–æ›´é«˜ç‰ˆæœ¬
- **Bun**: 1.0.0 æˆ–æ›´é«˜ç‰ˆæœ¬
- **Nginx**: 1.20 æˆ–æ›´é«˜ç‰ˆæœ¬ï¼ˆå®å¡”è‡ªå¸¦ï¼‰

---

## ç¬¬ä¸€éƒ¨åˆ†ï¼šæœåŠ¡å™¨ç¯å¢ƒå‡†å¤‡

### 1.1 å®‰è£…å®å¡”é¢æ¿

å¦‚æœè¿˜æœªå®‰è£…å®å¡”é¢æ¿ï¼Œæ‰§è¡Œä»¥ä¸‹å‘½ä»¤ï¼š

```bash
# Ubuntu/Debian ç³»ç»Ÿ
wget -O install.sh https://download.bt.cn/install/install-ubuntu_6.0.sh && sudo bash install.sh
```

å®‰è£…å®Œæˆåï¼Œè®°å½•ä¸‹ï¼š
- å®å¡”é¢æ¿åœ°å€ï¼ˆå¦‚ï¼šhttp://your-ip:8888ï¼‰
- ç”¨æˆ·å
- å¯†ç 

### 1.2 ç™»å½•å®å¡”é¢æ¿

1. åœ¨æµè§ˆå™¨ä¸­æ‰“å¼€å®å¡”é¢æ¿åœ°å€
2. ä½¿ç”¨å®‰è£…æ—¶ç”Ÿæˆçš„ç”¨æˆ·åå’Œå¯†ç ç™»å½•
3. é¦–æ¬¡ç™»å½•ä¼šæç¤ºå®‰è£…æ¨èçš„è½¯ä»¶ï¼Œå¯ä»¥è·³è¿‡ï¼Œæˆ‘ä»¬æ‰‹åŠ¨å®‰è£…

### 1.3 é…ç½®é˜²ç«å¢™

åœ¨å®å¡”é¢æ¿ä¸­ï¼š
1. è¿›å…¥ **å®‰å…¨** èœå•
2. æ”¾è¡Œä»¥ä¸‹ç«¯å£ï¼š
   - `80` (HTTP)
   - `443` (HTTPS)
   - `8888` (å®å¡”é¢æ¿ï¼Œå¯æ”¹)
   - `30001` (å‰ç«¯åº”ç”¨ï¼Œä»…å†…ç½‘ï¼Œä¸å¯¹å¤–å¼€æ”¾)
   - `30002` (åç«¯APIï¼Œä»…å†…ç½‘ï¼Œä¸å¯¹å¤–å¼€æ”¾)

**æ³¨æ„**: 30001 å’Œ 30002 ç«¯å£åº”è¯¥åªåœ¨å†…ç½‘ä½¿ç”¨ï¼Œé€šè¿‡ Nginx åå‘ä»£ç†å¯¹å¤–æä¾›æœåŠ¡ã€‚

---

## ç¬¬äºŒéƒ¨åˆ†ï¼šå®‰è£…è¿è¡Œæ—¶ç¯å¢ƒ

### 2.1 å®‰è£… Node.js

é€šè¿‡å®å¡”é¢æ¿å®‰è£…ï¼š

1. è¿›å…¥ **è½¯ä»¶å•†åº—**
2. æœç´¢ "Node.js ç‰ˆæœ¬ç®¡ç†å™¨"
3. å®‰è£… "Node.js ç‰ˆæœ¬ç®¡ç†å™¨"
4. å®‰è£…å®Œæˆåï¼Œç‚¹å‡» "è®¾ç½®"
5. å®‰è£… Node.js 18.x æˆ–æ›´é«˜ç‰ˆæœ¬

æˆ–è€…é€šè¿‡å‘½ä»¤è¡Œå®‰è£…ï¼š

```bash
# å®‰è£… Node.js 18.x
curl -fsSL https://deb.nodesource.com/setup_18.x | sudo -E bash -
sudo apt-get install -y nodejs

# éªŒè¯å®‰è£…
node --version  # åº”è¯¥æ˜¾ç¤º v18.x.x
npm --version
```

### 2.2 å®‰è£… Bun

Bun æ˜¯åç«¯è¿è¡Œæ—¶ï¼Œéœ€è¦æ‰‹åŠ¨å®‰è£…ï¼š

```bash
# å®‰è£… Bun
curl -fsSL https://bun.sh/install | bash

# å°† Bun æ·»åŠ åˆ°ç³»ç»Ÿè·¯å¾„
echo 'export PATH="$HOME/.bun/bin:$PATH"' >> ~/.bashrc
source ~/.bashrc

# éªŒè¯å®‰è£…
bun --version  # åº”è¯¥æ˜¾ç¤º 1.x.x
```

### 2.3 å®‰è£… PostgreSQL

é€šè¿‡å®å¡”é¢æ¿å®‰è£…ï¼š

1. è¿›å…¥ **è½¯ä»¶å•†åº—**
2. æœç´¢ "PostgreSQL"
3. é€‰æ‹© PostgreSQL 14 æˆ–æ›´é«˜ç‰ˆæœ¬
4. ç‚¹å‡» **å®‰è£…**
5. ç­‰å¾…å®‰è£…å®Œæˆ

æˆ–è€…é€šè¿‡å‘½ä»¤è¡Œå®‰è£…ï¼š

```bash
# å®‰è£… PostgreSQL
sudo apt update
sudo apt install postgresql postgresql-contrib -y

# å¯åŠ¨ PostgreSQL æœåŠ¡
sudo systemctl start postgresql
sudo systemctl enable postgresql

# éªŒè¯å®‰è£…
sudo -u postgres psql --version
```

---

## ç¬¬ä¸‰éƒ¨åˆ†ï¼šæ•°æ®åº“é…ç½®

### 3.1 åˆ›å»ºæ•°æ®åº“å’Œç”¨æˆ·

é€šè¿‡å®å¡”é¢æ¿ï¼š

1. è¿›å…¥ **æ•°æ®åº“** èœå•
2. é€‰æ‹© **PostgreSQL** æ ‡ç­¾
3. ç‚¹å‡» **æ·»åŠ æ•°æ®åº“**
4. å¡«å†™ä»¥ä¸‹ä¿¡æ¯ï¼š
   - **æ•°æ®åº“å**: `ucass_datashare`
   - **ç”¨æˆ·å**: `ucass_datashare`
   - **å¯†ç **: è®¾ç½®ä¸€ä¸ªå¼ºå¯†ç ï¼ˆè®°å½•ä¸‹æ¥ï¼‰

æˆ–è€…é€šè¿‡å‘½ä»¤è¡Œï¼š

```bash
# åˆ‡æ¢åˆ° postgres ç”¨æˆ·
sudo -u postgres psql

# åœ¨ PostgreSQL å‘½ä»¤è¡Œä¸­æ‰§è¡Œä»¥ä¸‹å‘½ä»¤ï¼š
CREATE USER ucass_datashare WITH PASSWORD 'your_strong_password';
CREATE DATABASE ucass_datashare OWNER ucass_datashare;
GRANT ALL PRIVILEGES ON DATABASE ucass_datashare TO ucass_datashare;

# é€€å‡º
\q
```

### 3.2 é…ç½® PostgreSQL å…è®¸æœ¬åœ°è¿æ¥

ç¼–è¾‘ PostgreSQL é…ç½®æ–‡ä»¶ï¼ˆå¦‚æœéœ€è¦ï¼‰ï¼š

```bash
# ç¼–è¾‘ pg_hba.conf
sudo nano /etc/postgresql/14/main/pg_hba.conf
```

ç¡®ä¿åŒ…å«ä»¥ä¸‹è¡Œï¼ˆé€šå¸¸å·²ç»å­˜åœ¨ï¼‰ï¼š

```
# IPv4 local connections:
host    all             all             127.0.0.1/32            md5
```

é‡å¯ PostgreSQLï¼š

```bash
sudo systemctl restart postgresql
```

### 3.3 æµ‹è¯•æ•°æ®åº“è¿æ¥

```bash
# æµ‹è¯•è¿æ¥
psql -h localhost -U ucass_datashare -d ucass_datashare -W

# è¾“å…¥å¯†ç åï¼Œå¦‚æœæˆåŠŸè¿æ¥ï¼Œè¾“å…¥ \q é€€å‡º
```

---

## ç¬¬å››éƒ¨åˆ†ï¼šé¡¹ç›®éƒ¨ç½²

### 4.1 åˆ›å»ºé¡¹ç›®ç›®å½•

å»ºè®®å°†é¡¹ç›®éƒ¨ç½²åœ¨ `/www/wwwroot/` ç›®å½•ä¸‹ï¼š

```bash
# åˆ›å»ºé¡¹ç›®ç›®å½•
sudo mkdir -p /www/wwwroot/ucass-datashare
cd /www/wwwroot/ucass-datashare

# è®¾ç½®ç›®å½•æƒé™ï¼ˆå‡è®¾å½“å‰ç”¨æˆ·ä¸º ubuntuï¼‰
sudo chown -R $USER:$USER /www/wwwroot/ucass-datashare
```

### 4.2 ä¸Šä¼ é¡¹ç›®ä»£ç 

æœ‰å‡ ç§æ–¹å¼ä¸Šä¼ ä»£ç ï¼š

**æ–¹å¼ä¸€ï¼šé€šè¿‡å®å¡”é¢æ¿ä¸Šä¼ **

1. è¿›å…¥ **æ–‡ä»¶** èœå•
2. å¯¼èˆªåˆ° `/www/wwwroot/ucass-datashare`
3. ç‚¹å‡» **ä¸Šä¼ ** æŒ‰é’®
4. ä¸Šä¼ é¡¹ç›®å‹ç¼©åŒ…ï¼ˆ.zip æˆ– .tar.gzï¼‰
5. è§£å‹æ–‡ä»¶

**æ–¹å¼äºŒï¼šé€šè¿‡ Gitï¼ˆæ¨èï¼‰**

```bash
cd /www/wwwroot/ucass-datashare

# å¦‚æœæ˜¯ç§æœ‰ä»“åº“ï¼Œéœ€è¦å…ˆé…ç½® SSH å¯†é’¥æˆ–ä½¿ç”¨ HTTPS
git clone https://your-git-repo-url.git .

# æˆ–è€…ï¼Œå¦‚æœå·²æœ‰ä»£ç ï¼Œç›´æ¥ä½¿ç”¨
```

**æ–¹å¼ä¸‰ï¼šé€šè¿‡ SCP/SFTP**

ä½¿ç”¨ FileZillaã€WinSCP ç­‰å·¥å…·ä¸Šä¼ ã€‚

### 4.3 é…ç½®ç¯å¢ƒå˜é‡

#### 4.3.1 é…ç½®åç«¯ç¯å¢ƒå˜é‡

```bash
cd /www/wwwroot/ucass-datashare/apps/api-backend
nano .env
```

ç¼–è¾‘å†…å®¹å¦‚ä¸‹ï¼š

```bash
# Database
DATABASE_URL="postgresql://ucass_datashare:your_strong_password@localhost:5432/ucass_datashare"

# Server
PORT=30002
NODE_ENV=production

# JWT Secretï¼ˆç”Ÿäº§ç¯å¢ƒåŠ¡å¿…æ›´æ”¹ï¼ï¼‰
JWT_SECRET=your-super-secret-jwt-key-change-this-in-production

# File Upload
UPLOAD_DIR=/www/wwwroot/ucass-datashare/uploads
MAX_FILE_SIZE=10737418240

# Admin Credentials (for initial setup)
ADMIN_USERNAME=admin
ADMIN_PASSWORD=admin123
```

**é‡è¦å®‰å…¨æç¤º**ï¼š
1. å°† `your_strong_password` æ›¿æ¢ä¸ºæ•°æ®åº“å¯†ç 
2. å°† `JWT_SECRET` æ”¹ä¸ºå¼ºå¯†é’¥ï¼Œå¯ä»¥ç”¨ä»¥ä¸‹å‘½ä»¤ç”Ÿæˆï¼š
   ```bash
   openssl rand -base64 32
   ```
3. é¦–æ¬¡éƒ¨ç½²åï¼Œç«‹å³ä¿®æ”¹ç®¡ç†å‘˜å¯†ç 

#### 4.3.2 é…ç½®å‰ç«¯ç¯å¢ƒå˜é‡

```bash
cd /www/wwwroot/ucass-datashare/apps/web-frontend
nano .env
```

ç¼–è¾‘å†…å®¹å¦‚ä¸‹ï¼š

```bash
PORT=30001
# ä½¿ç”¨å†…ç½‘åœ°å€ï¼Œå› ä¸ºå‰åç«¯åœ¨åŒä¸€æœåŠ¡å™¨
API_BASE_URL=http://localhost:30002

# å¦‚æœéœ€è¦å¤–ç½‘è®¿é—®ï¼Œé…ç½®ä¸ºå®é™…çš„APIåœ°å€
# API_BASE_URL=http://your-domain.com/api
```

### 4.4 åˆ›å»ºä¸Šä¼ ç›®å½•

```bash
# åˆ›å»ºä¸Šä¼ ç›®å½•
mkdir -p /www/wwwroot/ucass-datashare/uploads

# è®¾ç½®æƒé™
chmod 755 /www/wwwroot/ucass-datashare/uploads
```

### 4.5 å®‰è£…ä¾èµ–

#### 4.5.1 å®‰è£…æ ¹ç›®å½•ä¾èµ–

```bash
cd /www/wwwroot/ucass-datashare
bun install
```

#### 4.5.2 å®‰è£…åç«¯ä¾èµ–

```bash
cd /www/wwwroot/ucass-datashare/apps/api-backend
bun install
```

#### 4.5.3 å®‰è£…å‰ç«¯ä¾èµ–

```bash
cd /www/wwwroot/ucass-datashare/apps/web-frontend
npm install
# æˆ–ä½¿ç”¨ bunï¼ˆå¦‚æœå‰ç«¯ä¹Ÿæ”¯æŒï¼‰
bun install
```

### 4.6 åˆå§‹åŒ–æ•°æ®åº“

```bash
cd /www/wwwroot/ucass-datashare/apps/api-backend

# ç”Ÿæˆ Prisma å®¢æˆ·ç«¯
bun run db:generate

# æ¨é€æ•°æ®åº“ schemaï¼ˆåˆ›å»ºè¡¨ï¼‰
bun run db:push

# åˆå§‹åŒ–ç§å­æ•°æ®ï¼ˆåˆ›å»ºç®¡ç†å‘˜è´¦å·ç­‰ï¼‰
bun run db:seed
```

### 4.7 æ„å»ºé¡¹ç›®

#### 4.7.1 æ„å»ºåç«¯

```bash
cd /www/wwwroot/ucass-datashare/apps/api-backend
bun run build
```

#### 4.7.2 æ„å»ºå‰ç«¯

```bash
cd /www/wwwroot/ucass-datashare/apps/web-frontend
npm run build
# æˆ–
bun run build
```

### 4.8 æµ‹è¯•å¯åŠ¨

å…ˆæ‰‹åŠ¨æµ‹è¯•å¯åŠ¨ï¼Œç¡®ä¿æ²¡æœ‰é—®é¢˜ï¼š

```bash
# æµ‹è¯•åç«¯
cd /www/wwwroot/ucass-datashare/apps/api-backend
bun start  # åº”è¯¥æ˜¾ç¤º "æœåŠ¡åœ°å€: http://localhost:30002"

# æ–°å¼€ä¸€ä¸ªç»ˆç«¯æµ‹è¯•å‰ç«¯
cd /www/wwwroot/ucass-datashare/apps/web-frontend
npm start  # åº”è¯¥æ˜¾ç¤º "ready on http://localhost:30001"
```

å¦‚æœéƒ½èƒ½æ­£å¸¸å¯åŠ¨ï¼ŒæŒ‰ `Ctrl+C` åœæ­¢ï¼Œç»§ç»­ä¸‹ä¸€æ­¥é…ç½®è¿›ç¨‹å®ˆæŠ¤ã€‚

---

## ç¬¬äº”éƒ¨åˆ†ï¼šå®å¡”é¢æ¿é…ç½®

### 5.1 å®‰è£… Nginxï¼ˆå¦‚æœæœªå®‰è£…ï¼‰

1. è¿›å…¥å®å¡”é¢æ¿ **è½¯ä»¶å•†åº—**
2. æœç´¢ "Nginx"
3. å®‰è£… Nginx 1.20 æˆ–æ›´é«˜ç‰ˆæœ¬

### 5.2 åˆ›å»ºç½‘ç«™

#### 5.2.1 æ·»åŠ ç«™ç‚¹

1. è¿›å…¥ **ç½‘ç«™** èœå•
2. ç‚¹å‡» **æ·»åŠ ç«™ç‚¹**
3. å¡«å†™ä»¥ä¸‹ä¿¡æ¯ï¼š
   - **åŸŸå**: å¡«å†™ä½ çš„åŸŸåï¼ˆå¦‚ï¼š`datashare.your-school.edu.cn`ï¼‰æˆ–æœåŠ¡å™¨IP
   - **æ ¹ç›®å½•**: `/www/wwwroot/ucass-datashare`ï¼ˆè¿™ä¸ªç›®å½•ä¸ä¼šç›´æ¥ä½¿ç”¨ï¼Œæˆ‘ä»¬ç”¨åå‘ä»£ç†ï¼‰
   - **PHPç‰ˆæœ¬**: é€‰æ‹© "çº¯é™æ€"
4. ç‚¹å‡» **æäº¤**

#### 5.2.2 é…ç½®åå‘ä»£ç†

ç‚¹å‡»åˆšåˆ›å»ºçš„ç½‘ç«™å³ä¾§çš„ **è®¾ç½®** æŒ‰é’®ï¼š

1. è¿›å…¥ **åå‘ä»£ç†** æ ‡ç­¾
2. ç‚¹å‡» **æ·»åŠ åå‘ä»£ç†**

**å‰ç«¯ä»£ç†é…ç½®**ï¼š

- **ä»£ç†åç§°**: `å‰ç«¯åº”ç”¨`
- **ç›®æ ‡URL**: `http://127.0.0.1:30001`
- **å‘é€åŸŸå**: `$host`
- **å†…å®¹æ›¿æ¢**: ç•™ç©º
- **é«˜çº§é…ç½®**: å¯é€‰ï¼Œæ·»åŠ ä»¥ä¸‹é…ç½®ï¼š

```nginx
proxy_set_header Host $host;
proxy_set_header X-Real-IP $remote_addr;
proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
proxy_set_header X-Forwarded-Proto $scheme;
proxy_http_version 1.1;
proxy_set_header Upgrade $http_upgrade;
proxy_set_header Connection "upgrade";
```

3. ä¿å­˜åï¼Œå†æ·»åŠ ä¸€ä¸ªä»£ç†ç”¨äºåç«¯ API

**åç«¯ API ä»£ç†é…ç½®**ï¼š

- **ä»£ç†åç§°**: `åç«¯API`
- **ç›®æ ‡URL**: `http://127.0.0.1:30002`
- **ä»£ç†è·¯å¾„**: `/api`ï¼ˆå‰ç«¯è¯·æ±‚ /api/* ä¼šè½¬å‘åˆ°åç«¯ï¼‰

**æ‰‹åŠ¨ç¼–è¾‘ Nginx é…ç½®ï¼ˆæ¨èï¼‰**ï¼š

å¦‚æœä½ ç†Ÿæ‚‰ Nginxï¼Œå¯ä»¥ç›´æ¥ç¼–è¾‘é…ç½®æ–‡ä»¶ï¼š

1. ç‚¹å‡»ç½‘ç«™çš„ **è®¾ç½®** â†’ **é…ç½®æ–‡ä»¶**
2. æ‰¾åˆ° `server` å—ï¼Œä¿®æ”¹ä¸ºï¼š

```nginx
server {
    listen 80;
    server_name your-domain.com;  # æ”¹ä¸ºä½ çš„åŸŸå

    # å‰ç«¯é™æ€èµ„æºå’Œé¡µé¢ï¼ˆNext.jsï¼‰
    location / {
        proxy_pass http://127.0.0.1:30001;
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $scheme;
        proxy_http_version 1.1;
        proxy_set_header Upgrade $http_upgrade;
        proxy_set_header Connection "upgrade";

        # å¢åŠ è¶…æ—¶æ—¶é—´ï¼ˆç”¨äºæ–‡ä»¶ä¸Šä¼ ï¼‰
        proxy_connect_timeout 600;
        proxy_send_timeout 600;
        proxy_read_timeout 600;
    }

    # åç«¯ API
    location /api {
        proxy_pass http://127.0.0.1:30002;
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $scheme;

        # å¢åŠ è¶…æ—¶æ—¶é—´ï¼ˆç”¨äºæ–‡ä»¶ä¸Šä¼ ï¼‰
        proxy_connect_timeout 600;
        proxy_send_timeout 600;
        proxy_read_timeout 600;

        # æ–‡ä»¶ä¸Šä¼ å¤§å°é™åˆ¶ï¼ˆ10GBï¼‰
        client_max_body_size 10G;
    }

    # æ–‡ä»¶ä¸‹è½½ï¼ˆå¦‚æœéœ€è¦ç›´æ¥è®¿é—®ä¸Šä¼ çš„æ–‡ä»¶ï¼‰
    location /uploads {
        alias /www/wwwroot/ucass-datashare/uploads;
        expires 30d;
        access_log off;
    }
}
```

3. ä¿å­˜åï¼Œç‚¹å‡» **é‡è½½é…ç½®**

### 5.3 è°ƒæ•´ PHP å’Œä¸Šä¼ é™åˆ¶

è™½ç„¶è¿™æ˜¯ Node.js é¡¹ç›®ï¼Œä½†æœ‰äº›é…ç½®éœ€è¦è°ƒæ•´ï¼š

1. è¿›å…¥ç½‘ç«™ **è®¾ç½®** â†’ **ç½‘ç«™ç›®å½•**
2. å–æ¶ˆ **é˜²è·¨ç«™æ”»å‡»** çš„å‹¾é€‰ï¼ˆå¯é€‰ï¼‰

---

## ç¬¬å…­éƒ¨åˆ†ï¼šåŸŸåä¸SSLé…ç½®

### 6.1 é…ç½®åŸŸåè§£æ

åœ¨ä½ çš„åŸŸåç®¡ç†é¢æ¿ï¼ˆå¦‚é˜¿é‡Œäº‘ã€è…¾è®¯äº‘ï¼‰ï¼š

1. æ·»åŠ  A è®°å½•ï¼š
   - **ä¸»æœºè®°å½•**: `datashare`ï¼ˆæˆ–è‡ªå®šä¹‰ï¼‰
   - **è®°å½•ç±»å‹**: `A`
   - **è®°å½•å€¼**: ä½ çš„æœåŠ¡å™¨å…¬ç½‘IP
   - **TTL**: é»˜è®¤å³å¯

2. ç­‰å¾… DNS è§£æç”Ÿæ•ˆï¼ˆä¸€èˆ¬ 5-10 åˆ†é’Ÿï¼‰

### 6.2 ç”³è¯·å…è´¹ SSL è¯ä¹¦

**æ–¹å¼ä¸€ï¼šä½¿ç”¨å®å¡”é¢æ¿ä¸€é”®ç”³è¯· Let's Encrypt**

1. è¿›å…¥ç½‘ç«™ **è®¾ç½®** â†’ **SSL**
2. é€‰æ‹© **Let's Encrypt**
3. è¾“å…¥é‚®ç®±åœ°å€
4. å‹¾é€‰åŸŸåï¼ˆç¡®ä¿åŸŸåå·²è§£æï¼‰
5. ç‚¹å‡» **ç”³è¯·**
6. ç­‰å¾…ç”³è¯·æˆåŠŸåï¼Œå¼€å¯ **å¼ºåˆ¶HTTPS**

**æ–¹å¼äºŒï¼šæ‰‹åŠ¨ä¸Šä¼ è¯ä¹¦**

å¦‚æœå­¦æ ¡æä¾›äº†è¯ä¹¦ï¼š

1. è¿›å…¥ç½‘ç«™ **è®¾ç½®** â†’ **SSL**
2. é€‰æ‹© **å…¶ä»–è¯ä¹¦**
3. ç²˜è´´è¯ä¹¦å†…å®¹ï¼ˆ.crt æˆ– .pemï¼‰
4. ç²˜è´´ç§é’¥å†…å®¹ï¼ˆ.keyï¼‰
5. ç‚¹å‡» **ä¿å­˜**
6. å¼€å¯ **å¼ºåˆ¶HTTPS**

---

## ç¬¬ä¸ƒéƒ¨åˆ†ï¼šè¿›ç¨‹å®ˆæŠ¤ä¸è‡ªåŠ¨é‡å¯

ä¸ºäº†ç¡®ä¿åº”ç”¨åœ¨åå°æŒç»­è¿è¡Œï¼Œå¹¶åœ¨å´©æºƒæ—¶è‡ªåŠ¨é‡å¯ï¼Œæˆ‘ä»¬éœ€è¦é…ç½®è¿›ç¨‹å®ˆæŠ¤ã€‚

### æ–¹å¼ä¸€ï¼šä½¿ç”¨ PM2ï¼ˆæ¨èï¼‰

PM2 æ˜¯ Node.js åº”ç”¨çš„è¿›ç¨‹ç®¡ç†å™¨ï¼Œæ”¯æŒè‡ªåŠ¨é‡å¯ã€æ—¥å¿—ç®¡ç†ç­‰ã€‚

#### 7.1 å®‰è£… PM2

```bash
sudo npm install -g pm2
```

#### 7.2 åˆ›å»º PM2 é…ç½®æ–‡ä»¶

```bash
cd /www/wwwroot/ucass-datashare
nano ecosystem.config.js
```

å†…å®¹å¦‚ä¸‹ï¼š

```javascript
module.exports = {
  apps: [
    {
      name: 'ucass-backend',
      cwd: '/www/wwwroot/ucass-datashare/apps/api-backend',
      script: 'bun',
      args: 'src/index.ts',
      interpreter: 'none',
      env: {
        NODE_ENV: 'production',
      },
      error_file: '/www/wwwroot/ucass-datashare/logs/backend-error.log',
      out_file: '/www/wwwroot/ucass-datashare/logs/backend-out.log',
      log_date_format: 'YYYY-MM-DD HH:mm:ss',
      max_memory_restart: '1G',
      autorestart: true,
      watch: false,
    },
    {
      name: 'ucass-frontend',
      cwd: '/www/wwwroot/ucass-datashare/apps/web-frontend',
      script: 'npm',
      args: 'start',
      interpreter: 'none',
      env: {
        NODE_ENV: 'production',
      },
      error_file: '/www/wwwroot/ucass-datashare/logs/frontend-error.log',
      out_file: '/www/wwwroot/ucass-datashare/logs/frontend-out.log',
      log_date_format: 'YYYY-MM-DD HH:mm:ss',
      max_memory_restart: '1G',
      autorestart: true,
      watch: false,
    },
  ],
};
```

#### 7.3 åˆ›å»ºæ—¥å¿—ç›®å½•

```bash
mkdir -p /www/wwwroot/ucass-datashare/logs
```

#### 7.4 å¯åŠ¨åº”ç”¨

```bash
cd /www/wwwroot/ucass-datashare

# å¯åŠ¨åº”ç”¨
pm2 start ecosystem.config.js

# æŸ¥çœ‹çŠ¶æ€
pm2 status

# æŸ¥çœ‹æ—¥å¿—
pm2 logs

# ä¿å­˜ PM2 é…ç½®
pm2 save

# è®¾ç½® PM2 å¼€æœºè‡ªå¯
pm2 startup
# æŒ‰ç…§è¾“å‡ºçš„æç¤ºæ‰§è¡Œå‘½ä»¤
```

#### 7.5 PM2 å¸¸ç”¨å‘½ä»¤

```bash
# æŸ¥çœ‹æ‰€æœ‰è¿›ç¨‹
pm2 list

# é‡å¯åº”ç”¨
pm2 restart ucass-backend
pm2 restart ucass-frontend

# åœæ­¢åº”ç”¨
pm2 stop ucass-backend

# æŸ¥çœ‹æ—¥å¿—
pm2 logs ucass-backend --lines 100

# æ¸…ç©ºæ—¥å¿—
pm2 flush

# ç›‘æ§
pm2 monit
```

### æ–¹å¼äºŒï¼šä½¿ç”¨ Systemd

å¦‚æœä¸æƒ³ä½¿ç”¨ PM2ï¼Œå¯ä»¥ä½¿ç”¨ç³»ç»Ÿè‡ªå¸¦çš„ systemdã€‚

#### åˆ›å»ºåç«¯æœåŠ¡

```bash
sudo nano /etc/systemd/system/ucass-backend.service
```

å†…å®¹ï¼š

```ini
[Unit]
Description=UCASS DataShare Backend API
After=network.target postgresql.service

[Service]
Type=simple
User=www-data
WorkingDirectory=/www/wwwroot/ucass-datashare/apps/api-backend
ExecStart=/root/.bun/bin/bun src/index.ts
Restart=on-failure
RestartSec=10
StandardOutput=append:/www/wwwroot/ucass-datashare/logs/backend-out.log
StandardError=append:/www/wwwroot/ucass-datashare/logs/backend-error.log

Environment=NODE_ENV=production

[Install]
WantedBy=multi-user.target
```

#### åˆ›å»ºå‰ç«¯æœåŠ¡

```bash
sudo nano /etc/systemd/system/ucass-frontend.service
```

å†…å®¹ï¼š

```ini
[Unit]
Description=UCASS DataShare Frontend
After=network.target ucass-backend.service

[Service]
Type=simple
User=www-data
WorkingDirectory=/www/wwwroot/ucass-datashare/apps/web-frontend
ExecStart=/usr/bin/npm start
Restart=on-failure
RestartSec=10
StandardOutput=append:/www/wwwroot/ucass-datashare/logs/frontend-out.log
StandardError=append:/www/wwwroot/ucass-datashare/logs/frontend-error.log

Environment=NODE_ENV=production

[Install]
WantedBy=multi-user.target
```

#### å¯åŠ¨æœåŠ¡

```bash
# é‡è½½ systemd
sudo systemctl daemon-reload

# å¯åŠ¨æœåŠ¡
sudo systemctl start ucass-backend
sudo systemctl start ucass-frontend

# è®¾ç½®å¼€æœºè‡ªå¯
sudo systemctl enable ucass-backend
sudo systemctl enable ucass-frontend

# æŸ¥çœ‹çŠ¶æ€
sudo systemctl status ucass-backend
sudo systemctl status ucass-frontend

# æŸ¥çœ‹æ—¥å¿—
sudo journalctl -u ucass-backend -f
```

---

## ç¬¬å…«éƒ¨åˆ†ï¼šæ—¥å¿—ä¸ç›‘æ§

### 8.1 é…ç½®æ—¥å¿—è½®è½¬

é˜²æ­¢æ—¥å¿—æ–‡ä»¶è¿‡å¤§ï¼š

```bash
sudo nano /etc/logrotate.d/ucass-datashare
```

å†…å®¹ï¼š

```
/www/wwwroot/ucass-datashare/logs/*.log {
    daily
    rotate 14
    compress
    delaycompress
    missingok
    notifempty
    create 0644 www-data www-data
}
```

### 8.2 ç›‘æ§åº”ç”¨

**ä½¿ç”¨å®å¡”é¢æ¿ç›‘æ§**ï¼š

1. è¿›å…¥ **ç³»ç»Ÿç›‘æ§**
2. æŸ¥çœ‹ CPUã€å†…å­˜ã€ç£ç›˜ä½¿ç”¨æƒ…å†µ

**ä½¿ç”¨ PM2 ç›‘æ§**ï¼ˆå¦‚æœä½¿ç”¨ PM2ï¼‰ï¼š

```bash
pm2 monit
```

### 8.3 å®šæœŸå¤‡ä»½

#### å¤‡ä»½æ•°æ®åº“

åœ¨å®å¡”é¢æ¿ï¼š

1. è¿›å…¥ **è®¡åˆ’ä»»åŠ¡**
2. æ·»åŠ ä»»åŠ¡ï¼š
   - **ä»»åŠ¡ç±»å‹**: å¤‡ä»½æ•°æ®åº“
   - **æ‰§è¡Œå‘¨æœŸ**: æ¯å¤© 2:00
   - **æ•°æ®åº“**: `ucass_datashare`
   - **å¤‡ä»½åˆ°**: `/www/backup/database`

æˆ–æ‰‹åŠ¨å¤‡ä»½ï¼š

```bash
# å¤‡ä»½æ•°æ®åº“
sudo -u postgres pg_dump ucass_datashare > /www/backup/database/ucass_datashare_$(date +%Y%m%d).sql

# å‹ç¼©å¤‡ä»½
gzip /www/backup/database/ucass_datashare_$(date +%Y%m%d).sql
```

#### å¤‡ä»½ä¸Šä¼ æ–‡ä»¶

```bash
# åˆ›å»ºå¤‡ä»½è„šæœ¬
nano /www/wwwroot/ucass-datashare/scripts/backup-uploads.sh
```

å†…å®¹ï¼š

```bash
#!/bin/bash
BACKUP_DIR="/www/backup/uploads"
UPLOAD_DIR="/www/wwwroot/ucass-datashare/uploads"
DATE=$(date +%Y%m%d)

mkdir -p $BACKUP_DIR
tar -czf $BACKUP_DIR/uploads_$DATE.tar.gz -C $UPLOAD_DIR .

# åˆ é™¤ 30 å¤©å‰çš„å¤‡ä»½
find $BACKUP_DIR -name "uploads_*.tar.gz" -mtime +30 -delete
```

è®¾ç½®æƒé™å¹¶æ·»åŠ åˆ°å®šæ—¶ä»»åŠ¡ï¼š

```bash
chmod +x /www/wwwroot/ucass-datashare/scripts/backup-uploads.sh

# æ·»åŠ åˆ° crontab
crontab -e
# æ·»åŠ ä»¥ä¸‹è¡Œï¼ˆæ¯å¤©å‡Œæ™¨3ç‚¹å¤‡ä»½ï¼‰
0 3 * * * /www/wwwroot/ucass-datashare/scripts/backup-uploads.sh
```

---

## å¸¸è§é—®é¢˜æ’æŸ¥

### 1. æ•°æ®åº“è¿æ¥å¤±è´¥

**ç—‡çŠ¶**: åç«¯å¯åŠ¨æ—¶æŠ¥é”™ "Can't reach database server"

**è§£å†³æ–¹æ¡ˆ**:

```bash
# æ£€æŸ¥ PostgreSQL æœåŠ¡çŠ¶æ€
sudo systemctl status postgresql

# å¯åŠ¨æœåŠ¡
sudo systemctl start postgresql

# æ£€æŸ¥è¿æ¥
psql -h localhost -U ucass_datashare -d ucass_datashare -W

# æ£€æŸ¥ .env ä¸­çš„ DATABASE_URL æ˜¯å¦æ­£ç¡®
```

### 2. ç«¯å£è¢«å ç”¨

**ç—‡çŠ¶**: å¯åŠ¨æ—¶æŠ¥é”™ "address already in use"

**è§£å†³æ–¹æ¡ˆ**:

```bash
# æŸ¥çœ‹ç«¯å£å ç”¨
sudo netstat -tulpn | grep 30001
sudo netstat -tulpn | grep 30002

# æ€æ­»å ç”¨è¿›ç¨‹
sudo kill -9 <PID>
```

### 3. æ–‡ä»¶ä¸Šä¼ å¤±è´¥

**ç—‡çŠ¶**: ä¸Šä¼ æ–‡ä»¶æ—¶æŠ¥é”™ 413 æˆ–è¶…æ—¶

**è§£å†³æ–¹æ¡ˆ**:

1. æ£€æŸ¥ Nginx é…ç½®ä¸­çš„ `client_max_body_size`
2. æ£€æŸ¥åç«¯ .env ä¸­çš„ `MAX_FILE_SIZE`
3. å¢åŠ è¶…æ—¶æ—¶é—´ï¼š

```nginx
# åœ¨ Nginx é…ç½®ä¸­æ·»åŠ 
proxy_connect_timeout 600;
proxy_send_timeout 600;
proxy_read_timeout 600;
client_max_body_size 10G;
```

### 4. æƒé™é—®é¢˜

**ç—‡çŠ¶**: æ— æ³•åˆ›å»ºä¸Šä¼ ç›®å½•æˆ–å†™å…¥æ–‡ä»¶

**è§£å†³æ–¹æ¡ˆ**:

```bash
# ä¿®æ”¹ä¸Šä¼ ç›®å½•æƒé™
sudo chown -R www-data:www-data /www/wwwroot/ucass-datashare/uploads
sudo chmod -R 755 /www/wwwroot/ucass-datashare/uploads
```

### 5. å‰ç«¯æ— æ³•è®¿é—®åç«¯ API

**ç—‡çŠ¶**: å‰ç«¯é¡µé¢åŠ è½½æ­£å¸¸ï¼Œä½†æ•°æ®æ— æ³•æ˜¾ç¤º

**è§£å†³æ–¹æ¡ˆ**:

1. æ£€æŸ¥å‰ç«¯ `.env` ä¸­çš„ `API_BASE_URL` é…ç½®
2. å¦‚æœä½¿ç”¨åå‘ä»£ç†ï¼Œç¡®ä¿ Nginx é…ç½®æ­£ç¡®
3. æ£€æŸ¥é˜²ç«å¢™è§„åˆ™

```bash
# æµ‹è¯•åç«¯ API
curl http://localhost:30002/health

# å¦‚æœæ— å“åº”ï¼Œæ£€æŸ¥åç«¯æ—¥å¿—
pm2 logs ucass-backend
```

### 6. SSL è¯ä¹¦é…ç½®åç½‘ç«™æ— æ³•è®¿é—®

**ç—‡çŠ¶**: é…ç½® HTTPS åæ— æ³•è®¿é—®ç½‘ç«™

**è§£å†³æ–¹æ¡ˆ**:

1. æ£€æŸ¥è¯ä¹¦æ˜¯å¦æ­£ç¡®å®‰è£…
2. æ£€æŸ¥é˜²ç«å¢™æ˜¯å¦æ”¾è¡Œ 443 ç«¯å£
3. æ£€æŸ¥ Nginx é…ç½®æ˜¯å¦æ­£ç¡®

```bash
# æµ‹è¯• Nginx é…ç½®
sudo nginx -t

# é‡å¯ Nginx
sudo systemctl restart nginx
```

### 7. PM2 è¿›ç¨‹é¢‘ç¹é‡å¯

**ç—‡çŠ¶**: PM2 æ˜¾ç¤ºè¿›ç¨‹ä¸æ–­é‡å¯

**è§£å†³æ–¹æ¡ˆ**:

```bash
# æŸ¥çœ‹è¯¦ç»†æ—¥å¿—
pm2 logs ucass-backend --lines 200

# å¸¸è§åŸå› ï¼š
# 1. ç«¯å£è¢«å ç”¨
# 2. ç¯å¢ƒå˜é‡é…ç½®é”™è¯¯
# 3. æ•°æ®åº“è¿æ¥å¤±è´¥
# 4. å†…å­˜ä¸è¶³

# æ£€æŸ¥å†…å­˜ä½¿ç”¨
pm2 monit
free -h
```

### 8. æ›´æ–°ä»£ç åæ”¹åŠ¨æœªç”Ÿæ•ˆ

**è§£å†³æ–¹æ¡ˆ**:

```bash
cd /www/wwwroot/ucass-datashare

# æ‹‰å–æœ€æ–°ä»£ç 
git pull

# å®‰è£…æ–°ä¾èµ–ï¼ˆå¦‚æœæœ‰ï¼‰
cd apps/api-backend && bun install
cd ../web-frontend && npm install

# é‡æ–°æ„å»º
cd ../api-backend && bun run build
cd ../web-frontend && npm run build

# é‡å¯æœåŠ¡
pm2 restart all

# å¦‚æœä½¿ç”¨ systemd
sudo systemctl restart ucass-backend
sudo systemctl restart ucass-frontend
```

### 9. æ•°æ®åº“è¿ç§»

å¦‚æœä¿®æ”¹äº†æ•°æ®åº“ schemaï¼š

```bash
cd /www/wwwroot/ucass-datashare/apps/api-backend

# ç”Ÿæˆæ–°çš„ Prisma å®¢æˆ·ç«¯
bun run db:generate

# æ¨é€ schema å˜æ›´
bun run db:push

# æˆ–ä½¿ç”¨è¿ç§»ï¼ˆæ¨èï¼‰
bun run db:migrate

# é‡å¯åç«¯
pm2 restart ucass-backend
```

---

## ç»´æŠ¤å»ºè®®

### æ—¥å¸¸ç»´æŠ¤

1. **æ¯å‘¨æ£€æŸ¥**:
   - ç³»ç»Ÿèµ„æºä½¿ç”¨æƒ…å†µï¼ˆCPUã€å†…å­˜ã€ç£ç›˜ï¼‰
   - åº”ç”¨æ—¥å¿—æ˜¯å¦æœ‰å¼‚å¸¸
   - æ•°æ®åº“è¿æ¥æ˜¯å¦æ­£å¸¸

2. **æ¯æœˆæ£€æŸ¥**:
   - æ›´æ–°ç³»ç»Ÿå®‰å…¨è¡¥ä¸
   - æ¸…ç†è¿‡æœŸæ—¥å¿—å’Œå¤‡ä»½
   - æ£€æŸ¥ SSL è¯ä¹¦æœ‰æ•ˆæœŸ

3. **å¤‡ä»½ç­–ç•¥**:
   - æ¯å¤©è‡ªåŠ¨å¤‡ä»½æ•°æ®åº“
   - æ¯å‘¨å¤‡ä»½ä¸Šä¼ æ–‡ä»¶
   - è‡³å°‘ä¿ç•™ 30 å¤©çš„å¤‡ä»½

### æ€§èƒ½ä¼˜åŒ–

1. **Nginx ç¼“å­˜**ï¼ˆå¯é€‰ï¼‰ï¼š

```nginx
# åœ¨ Nginx é…ç½®ä¸­æ·»åŠ 
location ~* \.(jpg|jpeg|png|gif|ico|css|js)$ {
    expires 30d;
    add_header Cache-Control "public, immutable";
}
```

2. **æ•°æ®åº“ä¼˜åŒ–**ï¼š

```sql
-- å®šæœŸæ‰§è¡Œ
VACUUM ANALYZE;

-- æŸ¥çœ‹æ•°æ®åº“å¤§å°
SELECT pg_size_pretty(pg_database_size('ucass_datashare'));
```

3. **æ—¥å¿—æ¸…ç†**ï¼š

```bash
# æ¸…ç† PM2 æ—¥å¿—
pm2 flush

# æ¸…ç†æ—§æ—¥å¿—æ–‡ä»¶
find /www/wwwroot/ucass-datashare/logs -name "*.log" -mtime +30 -delete
```

---

## é™„å½•

### å¸¸ç”¨å‘½ä»¤é€ŸæŸ¥

```bash
# æœåŠ¡ç®¡ç†ï¼ˆPM2ï¼‰
pm2 list                    # æŸ¥çœ‹æ‰€æœ‰è¿›ç¨‹
pm2 restart all             # é‡å¯æ‰€æœ‰è¿›ç¨‹
pm2 logs                    # æŸ¥çœ‹æ—¥å¿—
pm2 monit                   # ç›‘æ§

# æœåŠ¡ç®¡ç†ï¼ˆSystemdï¼‰
sudo systemctl status ucass-backend   # æŸ¥çœ‹çŠ¶æ€
sudo systemctl restart ucass-backend  # é‡å¯æœåŠ¡
sudo journalctl -u ucass-backend -f   # æŸ¥çœ‹æ—¥å¿—

# æ•°æ®åº“
psql -h localhost -U ucass_datashare -d ucass_datashare  # è¿æ¥æ•°æ®åº“
pg_dump ucass_datashare > backup.sql                     # å¤‡ä»½
psql ucass_datashare < backup.sql                        # æ¢å¤

# Nginx
sudo nginx -t                        # æµ‹è¯•é…ç½®
sudo systemctl restart nginx         # é‡å¯ Nginx
sudo tail -f /var/log/nginx/error.log  # æŸ¥çœ‹é”™è¯¯æ—¥å¿—

# ç£ç›˜å’Œèµ„æº
df -h                                # æŸ¥çœ‹ç£ç›˜ä½¿ç”¨
free -h                              # æŸ¥çœ‹å†…å­˜ä½¿ç”¨
top                                  # æŸ¥çœ‹è¿›ç¨‹èµ„æº
```

### è”ç³»æ–¹å¼

å¦‚é‡åˆ°é—®é¢˜ï¼Œå¯ä»¥ï¼š
1. æŸ¥çœ‹åº”ç”¨æ—¥å¿—
2. æŸ¥çœ‹å®å¡”é¢æ¿æ—¥å¿—
3. æŸ¥é˜…é¡¹ç›® README.md
4. è”ç³»ç³»ç»Ÿç®¡ç†å‘˜

---

**ç¥éƒ¨ç½²é¡ºåˆ©ï¼** ğŸ‰
