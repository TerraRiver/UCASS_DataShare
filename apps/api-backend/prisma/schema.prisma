// This is your Prisma schema file,
// learn more about it in the docs: https://pris.ly/d/prisma-schema

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

model AdminUser {
  id           String   @id @default(cuid())
  username     String   @unique
  passwordHash String   @map("password_hash")
  createdAt    DateTime @default(now()) @map("created_at")
  updatedAt    DateTime @updatedAt @map("updated_at")

  @@map("admin_users")
}

model Dataset {
  id                   String   @id @default(cuid())
  name                 String
  catalog              String
  summary              String?
  source               String
  sourceUrl            String?  @map("source_url")
  sourceDate           DateTime? @map("source_date")
  recommendedCitations String[] @default([]) @map("recommended_citations")
  enablePreview        Boolean  @default(false) @map("enable_preview")
  uploadedBy           String?  @map("uploaded_by")
  uploadTime           DateTime @default(now()) @map("upload_time")
  updateTime           DateTime @updatedAt @map("update_time")
  isReviewed           Boolean  @default(false) @map("is_reviewed")
  isVisible            Boolean  @default(false) @map("is_visible")
  isFeatured           Boolean  @default(false)
  enableDataAnalysis   Boolean  @default(false) @map("enable_data_analysis")
  downloadCount        Int      @default(0) @map("download_count")

  files                DatasetFile[]
  relatedCaseStudies   CaseStudyDataset[]

  @@map("datasets")
}

model DatasetFile {
  id          String   @id @default(cuid())
  filename    String
  originalName String  @map("original_name")
  filePath    String   @map("file_path")
  fileSize    BigInt   @map("file_size")
  fileType    String   @map("file_type")
  mimeType    String?  @map("mime_type")
  uploadTime  DateTime @default(now()) @map("upload_time")
  isPreviewable Boolean @default(false) @map("is_previewable")

  datasetId   String   @map("dataset_id")
  dataset     Dataset  @relation(fields: [datasetId], references: [id], onDelete: Cascade)

  @@map("dataset_files")
}

model CaseStudy {
  id            String   @id @default(cuid())
  title         String
  author        String
  discipline    String
  summary       String?  // 简述，可选，最多30字符
  publication   String
  publicationYear Int?     @map("publication_year")
  publicationUrl String?  @map("publication_url")
  practiceUrl   String?  @map("practice_url")
  uploadedBy    String?  @map("uploaded_by")
  uploadTime    DateTime @default(now()) @map("upload_time")
  updateTime    DateTime @updatedAt @map("update_time")
  isReviewed    Boolean  @default(false) @map("is_reviewed")
  isVisible     Boolean  @default(false) @map("is_visible")
  isFeatured    Boolean  @default(false) @map("is_featured")
  enablePractice Boolean @default(false) @map("enable_practice")
  hasVideo      Boolean  @default(false) @map("has_video")
  downloadCount Int      @default(0) @map("download_count")

  files         CaseStudyFile[]
  relatedDatasets CaseStudyDataset[]

  @@map("case_studies")
}

model CaseStudyFile {
  id           String   @id @default(cuid())
  filename     String
  originalName String   @map("original_name")
  filePath     String   @map("file_path")
  fileSize     BigInt   @map("file_size")
  fileType     String   @map("file_type")
  mimeType     String?  @map("mime_type")
  uploadTime   DateTime @default(now()) @map("upload_time")

  caseStudyId  String   @map("case_study_id")
  caseStudy    CaseStudy @relation(fields: [caseStudyId], references: [id], onDelete: Cascade)

  @@map("case_study_files")
}

// 案例集与数据集的多对多关系表
model CaseStudyDataset {
  id          String   @id @default(cuid())
  caseStudyId String   @map("case_study_id")
  datasetId   String   @map("dataset_id")
  createdAt   DateTime @default(now()) @map("created_at")

  caseStudy   CaseStudy @relation(fields: [caseStudyId], references: [id], onDelete: Cascade)
  dataset     Dataset   @relation(fields: [datasetId], references: [id], onDelete: Cascade)

  @@unique([caseStudyId, datasetId])
  @@map("case_study_datasets")
}

// RAG 向量化内容表
model EmbeddedContent {
  id          String   @id @default(cuid())
  contentType String   @map("content_type") // 'dataset' | 'casestudy'
  contentId   String   @map("content_id")   // 关联的 Dataset 或 CaseStudy ID
  title       String                         // 标题
  content     String   @db.Text             // 文本内容
  embedding   String   @db.Text             // 向量（存储为 JSON 字符串）
  metadata    Json?                          // 额外元数据
  createdAt   DateTime @default(now()) @map("created_at")
  updatedAt   DateTime @updatedAt @map("updated_at")

  @@index([contentType, contentId])
  @@map("embedded_contents")
}

// 系统配置表
model SystemSetting {
  id        String   @id @default(cuid())
  key       String   @unique  // 配置项的键名
  value     String   @db.Text // 配置项的值
  category  String   @default("general") // 配置分类：general, api, rag等
  isSecret  Boolean  @default(false) @map("is_secret") // 是否为敏感信息（如API key）
  createdAt DateTime @default(now()) @map("created_at")
  updatedAt DateTime @updatedAt @map("updated_at")

  @@map("system_settings")
}

// 方法模块分类（10大类）
model MethodCategory {
  id          String   @id @default(cuid())
  code        String   @unique  // DA, DP, QS, NLP, SNA, GIS, ML, SM, DV, CI
  name        String             // 数据获取, 数据预处理等
  englishName String   @map("english_name")  // Data Acquisition等
  sortOrder   Int      @default(0) @map("sort_order")
  createdAt   DateTime @default(now()) @map("created_at")
  updatedAt   DateTime @updatedAt @map("updated_at")

  modules     MethodModule[]

  @@map("method_categories")
}

// 方法模块
model MethodModule {
  id            String   @id @default(cuid())
  code          String   @unique  // DA01, DA02, NLP15等
  name          String             // 静态网页抓取
  englishName   String   @map("english_name")  // Static Scraping
  summary       String?  // 简述（可选）

  categoryId    String   @map("category_id")
  category      MethodCategory @relation(fields: [categoryId], references: [id])

  practiceUrl   String?  @map("practice_url")  // 实操链接
  enablePractice Boolean @default(false) @map("enable_practice")

  downloadCount Int      @default(0) @map("download_count")
  previewCount  Int      @default(0) @map("preview_count")

  uploadTime    DateTime @default(now()) @map("upload_time")
  updateTime    DateTime @updatedAt @map("update_time")
  isVisible     Boolean  @default(true) @map("is_visible")

  files         MethodModuleFile[]

  @@map("method_modules")
}

// 方法模块文件
model MethodModuleFile {
  id             String   @id @default(cuid())
  filename       String
  originalName   String   @map("original_name")
  relativePath   String?  @map("relative_path")  // 文件的相对路径，用于保持文件夹结构
  filePath       String   @map("file_path")
  fileSize       BigInt   @map("file_size")
  fileType       String   @map("file_type")
  mimeType       String?  @map("mime_type")
  uploadTime     DateTime @default(now()) @map("upload_time")

  methodModuleId String   @map("method_module_id")
  methodModule   MethodModule @relation(fields: [methodModuleId], references: [id], onDelete: Cascade)

  @@map("method_module_files")
}